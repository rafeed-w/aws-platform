name: Load Test

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Test duration (e.g., 5m, 10m)'
        required: true
        default: '5m'
        type: string
      users:
        description: 'Number of virtual users'
        required: true
        default: '50'
        type: string
      ramp_up:
        description: 'Ramp up duration (e.g., 2m)'
        required: true
        default: '2m'
        type: string

jobs:
  get-webapp-url:
    name: Get Webapp URL
    runs-on: ubuntu-latest
    outputs:
      webapp_url: ${{ steps.get_url.outputs.webapp_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Import Secrets from Vault
        uses: hashicorp/vault-action@v2
        id: secrets
        with:
          url: ${{ secrets.VAULT_URL }}
          token: ${{ secrets.VAULT_TOKEN }}
          exportEnv: true
          secrets: |
            secret/data/terraform token | TF_API_TOKEN ;
            secret/data/terraform organization | TF_CLOUD_ORGANIZATION

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ env.TF_API_TOKEN }}

      - name: Get webapp URL from Terraform output
        id: get_url
        run: |
          cd infra/tier3_deployments
          terraform init
          terraform refresh
          ARGOCD_URL=$(terraform output -raw argocd_url)
          # Extract the LoadBalancer hostname
          LB_HOST=$(echo "$ARGOCD_URL" | sed 's|http://||')
          # Use the same LoadBalancer for webapp (nginx ingress uses same LB)
          echo "webapp_url=http://$LB_HOST" >> $GITHUB_OUTPUT
          echo "Webapp URL: http://$LB_HOST"

  load-test:
    name: Run Load Test
    runs-on: ubuntu-latest
    needs: get-webapp-url

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Create k6 test script
        run: |
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export const options = {
            stages: [
              { duration: '${{ inputs.ramp_up }}', target: ${{ inputs.users }} }, // Ramp up
              { duration: '${{ inputs.duration }}', target: ${{ inputs.users }} }, // Stay at target
              { duration: '1m', target: 0 }, // Ramp down
            ],
          };

          export default function () {
            // Mix of regular requests and CPU-intensive requests
            const useLoadTest = Math.random() > 0.3; // 70% load test, 30% regular
            
            let response;
            if (useLoadTest) {
              // CPU-intensive endpoint with varying load
              const iterations = Math.floor(Math.random() * 2000000) + 500000; // 500k-2.5M iterations
              response = http.get(`${{ needs.get-webapp-url.outputs.webapp_url }}/load-test?iterations=${iterations}`);
            } else {
              // Regular endpoint
              response = http.get('${{ needs.get-webapp-url.outputs.webapp_url }}/');
            }
            
            check(response, {
              'status is 200': (r) => r.status === 200,
              'response time < 2000ms': (r) => r.timings.duration < 2000,
            });
            
            // Shorter sleep for more aggressive load
            sleep(Math.random() * 2); // 0-2s random sleep
          }
          EOF

      - name: Run k6 load test
        run: |
          echo "ğŸš€ Starting load test with ${{ inputs.users }} users for ${{ inputs.duration }}"
          echo "ğŸ“ Target URL: ${{ needs.get-webapp-url.outputs.webapp_url }}"
          echo "â±ï¸  Ramp up: ${{ inputs.ramp_up }}"

          k6 run --out json=results.json load-test.js
